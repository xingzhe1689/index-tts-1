# 抖音直播新人TTS欢迎插件

监听抖音直播间新人进入，自动生成个性化欢迎语音。

## 功能特点

- ✅ 自动监听新人进入直播间
- ✅ 实时打印用户名到控制台
- ✅ 自动生成TTS欢迎语音
- ✅ 个性化欢迎文案："热烈欢迎[用户名]进入直播间"
- ✅ 智能音频播放队列（顺序播放，避免重叠）
- ✅ 自动播放生成的欢迎语音
- ✅ 带颜色格式的日志输出
- ✅ 自动去重，不会重复提示
- ✅ 显示进入时间
- ✅ 控制台命令控制播放功能

## 安装方法

### Chrome/Edge 浏览器

1. 打开浏览器，进入扩展管理页面：
   - Chrome: 访问 `chrome://extensions/`
   - Edge: 访问 `edge://extensions/`

2. 打开右上角的「开发者模式」

3. 点击「加载已解压的扩展程序」

4. 选择本插件所在的文件夹（chajian）

5. 安装完成！

## 使用方法

### 前置要求

1. **启动TTS API服务器**：
   ```bash
   # 确保IndexTTS2 API服务器正在运行
   uv run api_server.py
   ```
   服务器默认运行在 `http://localhost:8000`

2. **音频文件服务**：
   API服务器会自动提供音频文件的HTTP访问服务：
   - 生成的音频文件存储在 `outputs/` 文件夹
   - 通过 `http://localhost:8000/audio/{task_id}` 访问（无需.wav扩展名）
   - 支持GET和HEAD请求方法
   - 支持跨域访问，无需额外配置

2. **准备默认音频文件**：
   - 将默认说话人音频文件放置在 `uploads/lyq_01.wav`
   - 确保TTS API可以正常工作

### 插件使用

1. 安装插件后，访问任意抖音直播间：https://live.douyin.com/xxxxx

2. 打开浏览器开发者工具（F12 或右键 -> 检查）

3. 切换到「Console」（控制台）标签页

4. 当有新用户进入直播间时，控制台会显示：
   ```
   🎉 新用户进入
   用户名: 让我冬个眠
   操作: 来了
   时间: 19:44:25
   -------------------
   🎤 开始生成欢迎语音: "热烈欢迎让我冬个眠进入直播间"
   🔗 发送TTS请求到: http://localhost:8000/tts (用户: 让我冬个眠)
   📡 TTS响应状态 (让我冬个眠): 200 OK
   ✅ 欢迎语音生成成功 (让我冬个眠): abc123...
   🎵 构造音频URL (让我冬个眠): http://localhost:8000/audio/abc123
   ✅ 音频文件可访问 (让我冬个眠)
   🎶 已添加到播放队列 (让我冬个眠)
   ▶️ 正在播放: 让我冬个眠
   ```

5. **异步播放机制**: TTS请求完全异步，任何一个请求完成就立即播放，无需等待所有请求完成，大大提升响应速度

6. **智能播放队列**: 自动排队播放，确保音频顺序播放，避免重叠冲突

6. **播放队列说明**：
   - 新人进入时会依次加入播放队列
   - 按进入顺序依次播放，避免语音重叠
   - 支持控制台手动控制播放功能

### 播放队列机制

插件实现了智能的音频播放队列系统：

#### **队列工作原理**
1. **请求即播**: 每个TTS请求完成时立即可播放，无需等待其他请求
2. **先进先出(FIFO)**: 按请求完成的顺序加入播放队列
3. **单线程播放**: 同时只播放一个音频，避免重叠
4. **无缝衔接**: 当前音频播放完毕后立即播放队列中的下一个
5. **即时响应**: 不等待所有请求完成，哪个先完成就先播哪个

#### **队列状态示例**
```
当前播放: 小明
待播放队列: 小红 → 小刚 → 小丽
状态: ▶️ 正在播放
```

#### **优化后的运行示例**
```
T=0.0s: 小明进入直播间 → 发送TTS请求 (异步)
T=0.5s: 小红进入直播间 → 发送TTS请求 (异步)
T=1.0s: 小刚进入直播间 → 发送TTS请求 (异步)
T=1.1s: 小明TTS完成 → 立即加载并播放小明 (无需等待验证)
T=1.6s: 小红TTS完成 → 加入队列等待 (小明播放中)
T=1.9s: 小刚TTS完成 → 加入队列等待 (小明播放中)
T=3.5s: 小明播放结束 → 立即播放小红 (无缝衔接)
T=5.5s: 小红播放结束 → 立即播放小刚 (无缝衔接)
```

**关键优化**:
- ✅ **零验证延迟**: 移除HEAD请求验证，直接播放
- ✅ **完全异步**: 每个请求完全独立，不阻塞
- ✅ **智能加载**: 等待音频完全加载后再播放
- ✅ **无缝衔接**: 当前播放结束后立即播放下一个

#### **并发处理**
- 支持多人同时进入直播间
- 每个人的TTS请求异步处理
- 哪个请求先完成就先加入播放队列
- 保证播放顺序与进入顺序一致

### 播放控制

打开浏览器控制台，输入以下命令控制播放：

```javascript
// 配置相关
ttsPlugin.setApiUrl("http://localhost:8000")  // 设置API服务器地址
ttsPlugin.getConfig()                        // 查看当前配置

// 播放控制
ttsPlugin.getStatus()                        // 查看播放队列状态
ttsPlugin.stop()                             // 停止播放并清空队列
ttsPlugin.toggleAutoPlay()                   // 切换自动播放开关
ttsPlugin.setVolume(0.8)                     // 设置播放音量(0.0-1.0)
ttsPlugin.playNext()                         // 手动播放下一个

// 帮助
ttsPlugin.help()                             // 显示所有可用命令
```

### 自定义服务器地址

如果你的TTS API服务器不在默认地址，可以使用以下命令修改：

```javascript
// 修改为其他地址
ttsPlugin.setApiUrl("http://192.168.1.100:8000");

// 修改为HTTPS
ttsPlugin.setApiUrl("https://your-domain.com:8443");
```

修改后会自动更新所有相关的API端点地址。

### 本地测试

1. 打开 `test.html` 文件（在浏览器中直接打开）

2. 点击"添加新用户"按钮模拟单个新人进入

3. 点击"批量添加用户"按钮演示并发场景（5个用户快速进入）

4. 观察页面上方的"播放队列状态"和控制台输出，注意异步请求的处理顺序

5. 使用页面上的控制按钮测试播放队列功能：
   - **查看队列状态**: 显示当前队列信息
   - **模拟播放完成**: 模拟音频播放结束
   - **批量添加用户**: 演示真实的并发TTS请求和立即播放逻辑

5. **测试音频服务**：
   ```bash
   # 运行音频服务测试脚本
   uv run test_audio_service.py
   ```
   这个脚本会检查API服务器状态、音频文件目录和文件访问能力。

5. 确保TTS API服务器正在运行以测试完整功能

6. 在控制台使用 `ttsPlugin.help()` 查看所有可用命令

## 文件说明

- `manifest.json` - 插件配置文件，包含API权限设置
- `content.js` - 监听脚本，在抖音直播页面运行
- `test.html` - 本地测试页面，模拟抖音直播间环境

## 技术原理

- 使用 `MutationObserver` 监听DOM变化
- 监听 `.webcast-chatroom___item_new` 类的新增元素
- 从 `.v8LY0gZF` 类提取用户名
- 使用 `data-id` 属性进行去重处理
- 检测到新人进入时，自动调用TTS API生成欢迎语音
- 文案格式："热烈欢迎[用户名]到来"

## 注意事项

- 插件仅在 https://live.douyin.com/* 页面生效
- 需要保持开发者工具打开才能看到控制台输出
- 刷新页面后会清空已处理的用户记录
- **TTS功能需要IndexTTS2 API服务器运行在 localhost:8000**
- **需要准备默认音频文件 uploads/lyq_01.wav**
- TTS请求失败时会在控制台显示错误信息
- 建议在稳定的网络环境下使用以确保TTS请求成功

## 故障排除

### TTS连接问题

**错误信息**: `TTS API连接失败`

**解决方案**:
1. 确保IndexTTS2 API服务器正在运行：
   ```bash
   uv run api_server.py
   ```
2. 检查服务器是否在正确的端口（默认8000）
3. 确认防火墙没有阻止localhost连接

### FormData构造错误

**错误信息**: `Failed to construct 'FormData': parameter 1 is not of type 'HTMLFormElement'`

**原因**: JavaScript中FormData构造函数不接受数组参数

**正确用法**:
```javascript
// 错误
new FormData([['key', 'value']])

// 正确
const formData = new FormData();
formData.append('key', 'value');
```

**解决方案**: 该错误已在最新版本中修复。如果仍然遇到，请重新加载插件。

### TTS请求失败

**错误信息**: `TTS API请求失败: 400/500`

**解决方案**:
1. 检查API服务器日志中的错误信息
2. 确认 `uploads/lyq_01.wav` 文件存在且是有效的WAV格式
3. 检查API服务器是否有足够的内存和GPU资源

### 音频播放失败

**错误信息**: `音频播放被阻止` 或 `音频播放失败`

**解决方案**:
1. **浏览器自动播放策略**: 现代浏览器阻止自动播放，需要用户交互后才能播放
   - 解决方案：在直播页面上点击一下或允许该网站的自动播放
2. **API服务器未启动**: 确认TTS API服务器正在运行
   ```bash
   uv run api_server.py
   ```
3. **API地址配置错误**: 如果服务器不在localhost:8000，使用控制台命令修改：
   ```javascript
   ttsPlugin.setApiUrl("http://你的服务器地址:端口")
   ```
4. **音频文件不存在**: 检查outputs文件夹是否有对应的音频文件
5. **网络连接问题**: 确认浏览器能访问TTS服务器
6. **CORS问题**: API服务器已配置允许跨域访问，如仍有问题请检查防火墙设置

### 音频URL访问问题

**现象**: 音频URL返回404或无法访问

**解决方案**:
1. **确认API服务器运行**: 检查服务器是否在正确的端口运行
2. **检查音频文件**: 确认 `outputs/{task_id}.wav` 文件存在
3. **验证URL格式**: 插件会自动构造 `http://localhost:8000/audio/{task_id}`
4. **测试访问**: 在浏览器中直接访问音频URL确认可达

### HEAD请求被拒绝 (405错误)

**现象**: 测试脚本显示"HEAD请求被拒绝（405 Method Not Allowed）"

**原因**: API服务器最初不支持HEAD请求方法

**解决方案**:
1. **确认服务器版本**: 确保使用最新版本的API服务器
2. **重启服务器**: 如果正在运行，请重启API服务器以应用更新
3. **验证修复**: 运行 `uv run test_audio_service.py` 确认HEAD请求现在工作正常

**技术说明**: HEAD请求用于检查文件是否存在和获取元数据，不下载实际文件内容。插件使用HEAD请求来验证音频文件是否可访问，然后再进行播放。

### 播放队列问题

**现象**: 音频不按顺序播放 或 播放卡住

**解决方案**:
1. 使用控制台命令检查队列状态：`ttsPlugin.getStatus()`
2. 停止并重新开始：`ttsPlugin.stop()`
3. 检查浏览器是否阻止了音频播放
4. 确认TTS API服务器正常运行

### 播放顺序异常

**现象**: 欢迎语音播放顺序与用户进入顺序不一致

**原因**: 这是正常现象，因为TTS请求的处理时间不同

**说明**:
- 系统按TTS请求完成的顺序播放
- 不是按用户进入的时间顺序
- 这样可以减少用户等待时间，提升体验
- 如果需要严格按进入顺序，可以调整为同步处理模式

### 环境兼容性问题

**现象**: 插件启动时显示各种API不支持的错误

**原因**: 浏览器版本过旧或安全策略限制

**解决方案**:
1. **升级浏览器**: 使用最新版本的Chrome/Edge
2. **检查扩展权限**: 确保插件有必要的网络权限
3. **禁用安全策略**: 在开发者模式下测试时可能需要调整CSP
4. **查看控制台**: 插件会自动检测并报告兼容性问题

### 控制台调试信息

插件会在控制台输出详细的调试信息：
- `🔍 测试TTS API连接...` - 连接测试开始
- `✅ TTS API连接正常` - 连接成功
- `🎤 正在生成欢迎语音` - 开始生成语音
- `📡 TTS响应状态` - API响应状态
- `✅ 欢迎语音生成成功` - 生成成功

如果遇到问题，请查看控制台的完整错误信息并参考上述解决方案。
