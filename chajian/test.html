<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ–éŸ³ç›´æ’­æ–°äººæ’ä»¶æµ‹è¯•é¡µé¢</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background-color: #f0f0f0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .chatroom {
            border: 1px solid #ddd;
            height: 400px;
            overflow-y: auto;
            padding: 10px;
            background: #fafafa;
            margin-bottom: 20px;
        }
        .chat-item {
            margin-bottom: 10px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border-left: 3px solid #007bff;
        }
        .chat-item.new {
            border-left-color: #ff0050;
            background: #fff5f5;
        }
        .username {
            font-weight: bold;
            color: #007bff;
        }
        .action {
            color: #666;
            font-size: 0.9em;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .controls {
            margin-bottom: 20px;
        }
        #console {
            background: #000;
            color: #0f0;
            font-family: 'Courier New', monospace;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>æŠ–éŸ³ç›´æ’­æ–°äººTTSæ’ä»¶æµ‹è¯•</h1>

        <div class="controls">
            <button onclick="addNewUser()">æ·»åŠ æ–°ç”¨æˆ·</button>
            <button onclick="addMultipleUsers()">æ‰¹é‡æ·»åŠ ç”¨æˆ·ï¼ˆæ¼”ç¤ºå¹¶å‘ï¼‰</button>
            <button onclick="clearChat()">æ¸…ç©ºèŠå¤©</button>
            <button onclick="clearConsole()">æ¸…ç©ºæ§åˆ¶å°</button>
            <button onclick="showQueueStatus()">æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€</button>
            <button onclick="simulatePlayComplete()">æ¨¡æ‹Ÿæ’­æ”¾å®Œæˆ</button>
        </div>

        <h3>æ¨¡æ‹ŸèŠå¤©å®¤</h3>
        <div class="chatroom webcast-chatroom___list" id="chatroom">
            <!-- èŠå¤©æ¶ˆæ¯ä¼šåœ¨è¿™é‡Œæ˜¾ç¤º -->
        </div>

        <h3>æ’­æ”¾é˜Ÿåˆ—çŠ¶æ€</h3>
        <div id="queue-status">
            <div>ğŸ“Š é˜Ÿåˆ—é•¿åº¦: 0</div>
            <div>â–¶ï¸ æ­£åœ¨æ’­æ”¾: å¦</div>
            <div>ğŸ‘¤ å½“å‰æ’­æ”¾: æ— </div>
            <div>â­ï¸ ä¸‹ä¸€ä½æ’­æ”¾: æ— </div>
            <div>ğŸ“‹ é˜Ÿåˆ—åˆ—è¡¨: (ç©º)</div>
        </div>

        <h3>æ§åˆ¶å°è¾“å‡º</h3>
        <div id="console"></div>
    </div>

    <script>
        // æ¨¡æ‹Ÿæ§åˆ¶å°å’Œæ’­æ”¾é˜Ÿåˆ—
        const consoleDiv = document.getElementById('console');
        const queueStatusDiv = document.getElementById('queue-status');
        const originalLog = console.log;
        const originalError = console.error;

        // æ¨¡æ‹Ÿæ’­æ”¾é˜Ÿåˆ—çŠ¶æ€
        let mockQueue = {
            length: 0,
            isPlaying: false,
            currentUser: null,
            queueList: []
        };

        function updateQueueStatus() {
            const nextUser = mockQueue.length > 0 ? mockQueue.queueList[0] || 'æœªçŸ¥' : 'æ— ';
            const queueList = mockQueue.queueList.length > 0 ? mockQueue.queueList.join(' â†’ ') : '(ç©º)';

            queueStatusDiv.innerHTML = `
                <div>ğŸ“Š é˜Ÿåˆ—é•¿åº¦: ${mockQueue.length}</div>
                <div>â–¶ï¸ æ­£åœ¨æ’­æ”¾: ${mockQueue.isPlaying ? 'æ˜¯' : 'å¦'}</div>
                <div>ğŸ‘¤ å½“å‰æ’­æ”¾: ${mockQueue.currentUser || 'æ— '}</div>
                <div>â­ï¸ ä¸‹ä¸€ä½æ’­æ”¾: ${nextUser}</div>
                <div>ğŸ“‹ é˜Ÿåˆ—åˆ—è¡¨: ${queueList}</div>
            `;
        }

        function addToConsole(message, type = 'log') {
            const time = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f00' : '#0f0';
            consoleDiv.innerHTML += `<span style="color: ${color}">[${time}] ${message}</span>\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;

            // æ¨¡æ‹Ÿæ›´æ–°æ’­æ”¾é˜Ÿåˆ—çŠ¶æ€
            if (message.includes('å·²æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ—')) {
                const userName = message.split(':')[1]?.trim() || 'æœªçŸ¥ç”¨æˆ·';
                mockQueue.queueList.push(userName);
                mockQueue.length = mockQueue.queueList.length;
                updateQueueStatus();
            } else if (message.includes('å¼€å§‹æ’­æ”¾æ¬¢è¿è¯­éŸ³')) {
                mockQueue.isPlaying = true;
                mockQueue.currentUser = message.split(':')[1]?.trim().split('"')[0] || 'æœªçŸ¥';
                updateQueueStatus();
            } else if (message.includes('æ’­æ”¾å®Œæˆ')) {
                mockQueue.isPlaying = false;
                mockQueue.currentUser = null;
                if (mockQueue.queueList.length > 0) {
                    mockQueue.queueList.shift(); // ç§»é™¤ç¬¬ä¸€ä¸ª
                }
                mockQueue.length = mockQueue.queueList.length;
                updateQueueStatus();
            }
        }

        console.log = function(...args) {
            originalLog.apply(console, args);
            addToConsole(args.join(' '));
        };

        console.error = function(...args) {
            originalError.apply(console, args);
            addToConsole(args.join(' '), 'error');
        };

        // æ¨¡æ‹ŸæŠ–éŸ³èŠå¤©å®¤ç»“æ„
        let userCounter = 1;

        function addNewUser() {
            const chatroom = document.getElementById('chatroom');
            const userName = `æµ‹è¯•ç”¨æˆ·${userCounter++}`;

            // åˆ›å»ºæ–°çš„èŠå¤©é¡¹ç›®ï¼ˆæ¨¡æ‹ŸæŠ–éŸ³çš„ç»“æ„ï¼‰
            const chatItem = document.createElement('div');
            chatItem.className = 'webcast-chatroom___item chat-item new webcast-chatroom___item_new';
            chatItem.setAttribute('data-id', `test_${Date.now()}_${Math.random()}`);

            chatItem.innerHTML = `
                <span class="username v8LY0gZF">${userName}</span>
                <span class="action cL385mHb">æ¥äº†</span>
            `;

            chatroom.appendChild(chatItem);

            // ç§»é™¤.newç±»ï¼ˆæ¨¡æ‹ŸæŠ–éŸ³çš„è¡Œä¸ºï¼‰
            setTimeout(() => {
                chatItem.classList.remove('new');
            }, 1000);
        }

        function clearChat() {
            document.getElementById('chatroom').innerHTML = '';
        }

        function clearConsole() {
            consoleDiv.innerHTML = '';
        }

        function showQueueStatus() {
            console.log('ğŸµ å½“å‰æ’­æ”¾é˜Ÿåˆ—çŠ¶æ€:');
            console.log(`   é˜Ÿåˆ—é•¿åº¦: ${mockQueue.length}`);
            console.log(`   æ­£åœ¨æ’­æ”¾: ${mockQueue.isPlaying}`);
            console.log(`   å½“å‰ç”¨æˆ·: ${mockQueue.currentUser || 'æ— '}`);
        }

        function simulatePlayComplete() {
            if (mockQueue.isPlaying) {
                console.log(`â¹ï¸ æ’­æ”¾å®Œæˆ: ${mockQueue.currentUser}`);
                mockQueue.isPlaying = false;
                mockQueue.currentUser = null;
                mockQueue.length = Math.max(0, mockQueue.length - 1);
                updateQueueStatus();

                // å¦‚æœè¿˜æœ‰å¾…æ’­æ”¾çš„ï¼Œæ¨¡æ‹Ÿå¼€å§‹æ’­æ”¾ä¸‹ä¸€ä¸ª
                if (mockQueue.length > 0) {
                    setTimeout(() => {
                        mockQueue.isPlaying = true;
                        mockQueue.currentUser = `æ¨¡æ‹Ÿç”¨æˆ·${Math.floor(Math.random() * 100)}`;
                        console.log(`â–¶ï¸ å¼€å§‹æ’­æ”¾ä¸‹ä¸€ä¸ª: ${mockQueue.currentUser}`);
                        updateQueueStatus();
                    }, 1000);
                }
            } else {
                console.log('âš ï¸ å½“å‰æ²¡æœ‰æ­£åœ¨æ’­æ”¾çš„éŸ³é¢‘');
            }
        }

        function addMultipleUsers() {
            const userNames = ['å°æ˜', 'å°çº¢', 'å°åˆš', 'å°ä¸½', 'å°ç‹'];
            console.log(`ğŸš€ æ‰¹é‡æ·»åŠ  ${userNames.length} ä¸ªç”¨æˆ·ï¼Œæ¼”ç¤ºå¹¶å‘TTSè¯·æ±‚...`);
            console.log(`ğŸ“ é¢„æœŸè¡Œä¸º: æ¯ä¸ªTTSè¯·æ±‚å®Œæˆæ—¶ç«‹å³åŠ å…¥æ’­æ”¾é˜Ÿåˆ—`);
            console.log(`ğŸµ æ’­æ”¾è§„åˆ™: é¡ºåºæ’­æ”¾ï¼Œé¿å…é‡å `);

            userNames.forEach((name, index) => {
                setTimeout(() => {
                    addNewUserWithName(name);
                    // æ¨¡æ‹ŸTTSè¯·æ±‚å»¶è¿Ÿï¼ˆ0.5-2ç§’éšæœºï¼‰
                    const delay = 500 + Math.random() * 1500;
                    setTimeout(() => {
                        simulateTTSComplete(name);
                    }, delay);
                }, index * 200); // æ¯ä¸ªç”¨æˆ·é—´éš”200msè¿›å…¥
            });
        }

        function simulateTTSComplete(userName) {
            console.log(`âœ… TTSè¯·æ±‚å®Œæˆ: ${userName} (æ¨¡æ‹Ÿ)`);
            // è¿™é‡Œåº”è¯¥è°ƒç”¨ audioQueue.add()ï¼Œä½†åœ¨æµ‹è¯•é¡µé¢ä¸­æˆ‘ä»¬åªæ˜¯æ¨¡æ‹Ÿ
            console.log(`ğŸµ ${userName} å·²æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ—`);
        }

        function addNewUserWithName(customName) {
            const chatroom = document.getElementById('chatroom');
            const userName = customName || `æµ‹è¯•ç”¨æˆ·${userCounter++}`;

            // åˆ›å»ºæ–°çš„èŠå¤©é¡¹ç›®ï¼ˆæ¨¡æ‹ŸæŠ–éŸ³çš„ç»“æ„ï¼‰
            const chatItem = document.createElement('div');
            chatItem.className = 'webcast-chatroom___item chat-item new webcast-chatroom___item_new';
            chatItem.setAttribute('data-id', `test_${Date.now()}_${Math.random()}`);

            chatItem.innerHTML = `
                <span class="username v8LY0gZF">${userName}</span>
                <span class="action cL385mHb">æ¥äº†</span>
            `;

            chatroom.appendChild(chatItem);

            // æ¨¡æ‹ŸTTSè¯·æ±‚å»¶è¿Ÿå’Œæ’­æ”¾è¿‡ç¨‹
            console.log(`ğŸ¤ æ¨¡æ‹Ÿå‘é€TTSè¯·æ±‚: ${userName}`);
            const requestDelay = 300 + Math.random() * 1200; // 300-1500mséšæœºå»¶è¿Ÿ

            setTimeout(() => {
                console.log(`âœ… TTSè¯·æ±‚å®Œæˆ: ${userName} (${requestDelay.toFixed(0)}ms)`);
                console.log(`ğŸ¶ ç«‹å³æ·»åŠ åˆ°æ’­æ”¾é˜Ÿåˆ—: ${userName}`);
                mockQueue.queueList.push(userName);
                mockQueue.length = mockQueue.queueList.length;
                updateQueueStatus();

                // å¦‚æœæ²¡æœ‰åœ¨æ’­æ”¾ï¼Œç«‹å³å¼€å§‹æ’­æ”¾
                if (!mockQueue.isPlaying && mockQueue.queueList.length > 0) {
                    const nextUser = mockQueue.queueList[0];
                    mockQueue.isPlaying = true;
                    mockQueue.currentUser = nextUser;
                    console.log(`â–¶ï¸ ç«‹å³å¼€å§‹æ’­æ”¾: ${nextUser}`);
                    updateQueueStatus();

                    // æ¨¡æ‹Ÿæ’­æ”¾æ—¶é•¿
                    const playDuration = 1500 + Math.random() * 1000; // 1.5-2.5ç§’
                    setTimeout(() => {
                        console.log(`â¹ï¸ æ’­æ”¾å®Œæˆ: ${nextUser}`);
                        mockQueue.isPlaying = false;
                        mockQueue.currentUser = null;
                        mockQueue.queueList.shift();
                        mockQueue.length = mockQueue.queueList.length;
                        updateQueueStatus();

                        // å¦‚æœè¿˜æœ‰å¾…æ’­æ”¾çš„ï¼Œç»§ç»­æ’­æ”¾
                        if (mockQueue.queueList.length > 0) {
                            const next = mockQueue.queueList[0];
                            console.log(`â­ï¸ ç«‹å³æ’­æ”¾ä¸‹ä¸€ä¸ª: ${next}`);
                            setTimeout(() => {
                                mockQueue.isPlaying = true;
                                mockQueue.currentUser = next;
                                console.log(`â–¶ï¸ å¼€å§‹æ’­æ”¾: ${next}`);
                                updateQueueStatus();
                            }, 100); // çŸ­æš‚å»¶è¿Ÿæ¨¡æ‹Ÿæ— ç¼è¡”æ¥
                        }
                    }, playDuration);
                }
            }, requestDelay);

            // ç§»é™¤.newç±»ï¼ˆæ¨¡æ‹ŸæŠ–éŸ³çš„è¡Œä¸ºï¼‰
            setTimeout(() => {
                chatItem.classList.remove('new');
            }, 1000);
        }

        // ç¯å¢ƒå…¼å®¹æ€§æµ‹è¯•
        function testCompatibility() {
            console.log('ğŸ”§ æµ‹è¯•é¡µé¢ç¯å¢ƒå…¼å®¹æ€§...');

            try {
                const testFormData = new FormData();
                testFormData.append('test', 'value');
                console.log('âœ… FormData æ”¯æŒæ­£å¸¸');
            } catch (error) {
                console.error('âŒ FormData æµ‹è¯•å¤±è´¥:', error);
            }

            if (typeof fetch !== 'undefined') {
                console.log('âœ… fetch API æ”¯æŒæ­£å¸¸');
            } else {
                console.error('âŒ fetch API ä¸æ”¯æŒ');
            }

            try {
                const testAudio = new Audio();
                console.log('âœ… Audio API æ”¯æŒæ­£å¸¸');
            } catch (error) {
                console.error('âŒ Audio API æµ‹è¯•å¤±è´¥:', error);
            }
        }

        // æ’­æ”¾é˜Ÿåˆ—æ¼”ç¤º
        function demonstrateQueueLogic() {
            console.log('ğŸ­ æ’­æ”¾é˜Ÿåˆ—é€»è¾‘æ¼”ç¤º');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
            console.log('æ—¶é—´çº¿æ¨¡æ‹Ÿ:');
            console.log('T=0s:  å°æ˜è¿›å…¥ â†’ å‘é€TTSè¯·æ±‚A');
            console.log('T=0.2s: å°çº¢è¿›å…¥ â†’ å‘é€TTSè¯·æ±‚B');
            console.log('T=0.4s: å°åˆšè¿›å…¥ â†’ å‘é€TTSè¯·æ±‚C');
            console.log('T=0.8s: è¯·æ±‚Aå®Œæˆ â†’ ç«‹å³æ’­æ”¾å°æ˜ (é˜Ÿåˆ—: å°æ˜)');
            console.log('T=1.2s: è¯·æ±‚Bå®Œæˆ â†’ åŠ å…¥é˜Ÿåˆ—ç­‰å¾… (é˜Ÿåˆ—: å°æ˜ â†’ å°çº¢)');
            console.log('T=1.5s: è¯·æ±‚Cå®Œæˆ â†’ åŠ å…¥é˜Ÿåˆ—ç­‰å¾… (é˜Ÿåˆ—: å°æ˜ â†’ å°çº¢ â†’ å°åˆš)');
            console.log('T=3.8s: å°æ˜æ’­æ”¾å®Œæˆ â†’ ç«‹å³æ’­æ”¾å°çº¢ (é˜Ÿåˆ—: å°çº¢ â†’ å°åˆš)');
            console.log('T=6.2s: å°çº¢æ’­æ”¾å®Œæˆ â†’ ç«‹å³æ’­æ”¾å°åˆš (é˜Ÿåˆ—: å°åˆš)');
            console.log('T=8.6s: å°åˆšæ’­æ”¾å®Œæˆ â†’ é˜Ÿåˆ—æ¸…ç©º');
            console.log('');
            console.log('âœ… å…³é”®ç‰¹æ€§:');
            console.log('   â€¢ è¯·æ±‚å®Œæˆå³åˆ»å¯æ’­æ”¾');
            console.log('   â€¢ é¡ºåºæ’­æ”¾é¿å…é‡å ');
            console.log('   â€¢ æ— éœ€ç­‰å¾…æ‰€æœ‰è¯·æ±‚å®Œæˆ');
            console.log('â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”');
        }

        // é¡µé¢åŠ è½½æç¤º
        window.addEventListener('load', function() {
            console.log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            testCompatibility();
            demonstrateQueueLogic();
            console.log('');
            console.log('ç‚¹å‡»"æ·»åŠ æ–°ç”¨æˆ·"æŒ‰é’®æ¥æ¨¡æ‹Ÿæ–°äººè¿›å…¥');
            console.log('ç‚¹å‡»"æ‰¹é‡æ·»åŠ ç”¨æˆ·"æŒ‰é’®æ¼”ç¤ºå¹¶å‘åœºæ™¯');
            console.log('ç¡®ä¿æµè§ˆå™¨æ’ä»¶å·²åŠ è½½ä»¥æµ‹è¯•TTSåŠŸèƒ½');
        });
    </script>

    <!-- åŠ è½½æ’ä»¶è„šæœ¬ -->
    <script src="content.js"></script>
</body>
</html>
